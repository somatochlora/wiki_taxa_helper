<!DOCTYPE html>

<html lang="en">
    <head>
        <title>Wiki Taxa Helper</title>
    </head>
    <body>
        <p id = "intro">What taxa do you want to look up?</p>
        <input type = "text" default = "iNat taxon number" id = "iNatTaxonID">
        <button type = "button" id = "taxonSubmit">submit</button>
        <div id = "results"></div>

        <script>
            const getJSON = async url => {
                const response = await fetch(url);
                if(!response.ok) // check if response worked (no 404 errors etc...)
                    throw new Error(response.statusText);

                const data = response.json(); // get JSON from the response
                return data; // returns a promise, which resolves to this data value
            }

            async function getLicensedPhotos (taxonID) {
                const response = await fetch("https://api.inaturalist.org/v1/observations?photo_license=cc-by%2Ccc-by-sa%2Ccc0&taxon_id=" + taxonID)
                if(!response.ok)
                    throw new Error(response.statusText);
                const data = response.json();
                return data;
            } 

            /*async function getWikiDataTaxon (taxonID) {
                const sparqlQuery = 'SELECT ?item\nWHERE\n{\n?item wdt:P3151 "' + taxonID + '".\n}';
                const response = await fetch('https://query.wikidata.org/sparql?query=' + encodeURIComponent(sparqlQuery))
                if(!response.ok)
                    throw new Error(response.statusText);
                const data = response.text();
                return data;
            }*/

            document.querySelector('#taxonSubmit').addEventListener('click', function() {
                let taxonID = document.querySelector('#iNatTaxonID').value;
                getJSON("https://api.inaturalist.org/v1/taxa/" + taxonID).then(data => {
                    results = document.querySelector('#results');
                    
                    // to keep api requests reaonsable cap number of child api calls at 20. TODO: add pagination to get all children
                    childTaxaNum = data.results[0].children.length;
                    if (childTaxaNum > 20) {
                        childTaxaNum = 20;
                    }

                    for (let i = 0; i < childTaxaNum; i++) {
                        getLicensedPhotos(data.results[0].children[i].id).then(childData => {
                            let observationDiv = document.createElement('div');
                            let para = document.createElement('p');
                            let imagesDiv = document.createElement('div');
                            para.textContent = data.results[0].children[i].name + ": " + childData.total_results + " observations with licensed photos";
                            observationDiv.appendChild(para);
                            if (childData.total_results != 0) {
                                for (let observationIndex = 0; observationIndex < childData.results.length; observationIndex++) {
                                    
                                    for (let imageIndex = 0; imageIndex < childData.results[observationIndex].photos.length; imageIndex++) {
                                        let link = document.createElement('a')
                                        link.target = "_blank";
                                        link.href = "https://www.inaturalist.org/observations/" + childData.results[observationIndex].id;
                                        let image = document.createElement('img');
                                        // need to check license on each photo individually todo
                                        image.src = childData.results[observationIndex].photos[imageIndex].url;
                                        link.appendChild(image);
                                        imagesDiv.appendChild(link);
                                    }
                                    observationDiv.appendChild(imagesDiv);
                                } 
                            }                           
                            results.appendChild(observationDiv);

                            /*getWikiDataTaxon(data.results[0].children[i].id).then(wdData => {
                                alert(wdData);
                            }).catch(error => alert("error here" + error));*/

                        }).catch(error => {
                            alert("the problem is with the second request, number" + i);
                            alert(error)
                        });                  
                    }
                }).catch(error => {
                    alert("the problem is with the first request");
                    alert(error);
                });
            });
        </script>

    </body>
</html>
