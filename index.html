<!DOCTYPE html>

<html lang="en">
    <head>
        <title>Wiki Taxa Helper</title>
    </head>
    <body>
        <p id = "intro">What taxa do you want to look up?</p>
        <input type = "text" default = "iNat taxon number" id = "iNatTaxonID">
        <button type = "button" id = "taxonSubmit">submit</button>
        <div id = "results"></div>

        <script>
            const getJSON = async url => {
                const response = await fetch(url);
                if(!response.ok) // check if response worked (no 404 errors etc...)
                    throw new Error(response.statusText);

                const data = response.json(); // get JSON from the response
                return data; // returns a promise, which resolves to this data value
            }

            async function getLicensedPhotos (taxonID) {
                const response = await fetch("https://api.inaturalist.org/v1/observations?photo_license=cc-by%2Ccc-by-sa%2Ccc0&taxon_id=" + taxonID)
                if(!response.ok)
                    throw new Error(response.statusText);
                const data = response.json();
                return data;
            } 



            document.querySelector('#taxonSubmit').addEventListener('click', function() {
                let taxonID = document.querySelector('#iNatTaxonID').value;
                getJSON("https://api.inaturalist.org/v1/taxa/" + taxonID).then(data => {
                    results = document.querySelector('#results');
                    for (let i = 0; i < data.results[0].children.length; i++) {
                        getLicensedPhotos(data.results[0].children[i].id).then(childData => {
                            let observationDiv = document.createElement('div');
                            let para = document.createElement('p');
                            let imagesDiv = document.createElement('div');
                            para.textContent = data.results[0].children[i].name + ": " + childData.total_results + " observations with licensed photos";
                            for (let imageIndex = 0; imageIndex < childData.results.length; imageIndex++) {
                                let image = document.createElement('img');
                                // currently only gets first photo todo
                                // need to check license on each photo individually todo
                                image.src = childData.results[imageIndex].photos[0].url;
                                imagesDiv.appendChild(image);
                            }
                            observationDiv.appendChild(para);
                            observationDiv.appendChild(imagesDiv);
                            results.appendChild(observationDiv);
                        }).catch(error => alert(error));                  
                    }
                }).catch(error => {
                    alert(error);
                });
            });
        </script>

    </body>
</html>
